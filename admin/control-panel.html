<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Control Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="../inventory-seed.js"></script>
  <style>
    :root {
      --font-main: "Inter","Segoe UI",system-ui,-apple-system,sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    html { font-family: var(--font-main); }
    *, *::before, *::after { box-sizing:border-box; font-family: inherit; margin:0; padding:0; }
    body{font-family:inherit;background:#f5f7f6;color:#0b2520;line-height:1.5;padding:0;}
    a { color: inherit; text-decoration: none; }
    header.site-header { background:#ffffff; position:sticky; top:0; z-index:50; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .nav { max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:10px 20px;gap:12px; flex-wrap:wrap; }
    .logo { display:flex; align-items:center; gap:10px; }
    .logo img { height:60px; width:auto; object-fit:contain; }
    .nav-links { display:flex; align-items:center; gap:18px; font-size:14px; flex-wrap:wrap; flex:1; justify-content:flex-end; }
    .nav-links a { padding:6px 10px; border-radius:999px; }
    .nav-links a:hover { background:rgba(0,94,74,.08); }
    .nav-links .active { background:#005e4a; color:#fff; }
    .nav-actions { display:flex; align-items:center; justify-content:flex-end; }
    .btn-small { border-radius:999px; border:1px solid #005e4a; padding:10px 22px; font-size:14px; font-weight:700; color:#005e4a; background:#fff; cursor:pointer; }
    .btn-small:hover { background:#005e4a; color:#fff; }
    .page { max-width:1200px; margin:20px auto 40px; padding:0 20px; }
    img{max-width:100%;height:auto;display:block;}
    h1{font-size:26px;font-weight:800;color:#0b2520;margin-bottom:6px;}
    p.lead{font-size:13px;color:#444;margin-bottom:16px;}
    .panel{background:#fff;border:1px solid #d8e5e0;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.06);}
    .flex{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start;margin-bottom:14px;}
    label{font-weight:700;font-size:12px;display:block;margin-bottom:6px;color:#0b2520;}
    input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #cfdad7;font-size:13px;}
    textarea{min-height:110px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-bottom:10px;}
    .btn{border:none;border-radius:999px;padding:10px 16px;font-weight:700;font-size:13px;cursor:pointer;}
    .btn.primary{background:#005e4a;color:#fff;}
    .btn.ghost{background:#fff;color:#005e4a;border:1px solid #005e4a;}
    .btn[disabled]{opacity:0.5; cursor:not-allowed;}
    .notice{background:#fff7e6;border:1px solid #ffe0a8;color:#6a3a00;padding:10px 12px;border-radius:10px;font-size:12px;margin-bottom:14px;}
    .muted{font-size:12px;color:#555;margin-bottom:10px;}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #cfe2de;border-radius:999px;padding:6px 10px;font-size:11px;font-weight:700;color:#0b2520;background:#f4faf8;}
    .thumb-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px;}
    .thumb{position:relative;border:1px solid #d8e5e0;border-radius:8px;overflow:hidden;background:#f2f6f5;}
    .thumb img{width:100%;height:90px;object-fit:cover;}
    .thumb button{position:absolute;top:6px;right:6px;border:none;background:rgba(0,0,0,0.55);color:#fff;border-radius:6px;padding:4px 6px;font-size:11px;cursor:pointer;}
    .canvas-wrap{width:100%;background:#f8fbfa;border:1px dashed #cfe2de;border-radius:12px;overflow:auto;margin-top:10px;}
    canvas{display:block;width:100%;}
    .status-pill{padding:4px 8px;border-radius:999px;font-weight:700;font-size:11px;display:inline-block;}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="nav">
      <div class="logo">
        <a href="../index.html"><img src="../Media/LogoTransparent.png" alt="M&T Equipment Funding Logo"></a>
      </div>
      <nav class="nav-links">
        <a href="control-panel.html" class="active">Control Panel</a>
        <a href="reports.html">Reports</a>
        <a href="admin-log.html">Admin Log</a>
        <a href="../index.html">Back to Site</a>
      </nav>
      <div class="nav-actions">
        <button class="btn-small" type="button" data-track-id="cta_talk_rep" data-track-label="Talk to Representative" onclick="window.location.href='tel:2012013551'">Talk to Representative</button>
      </div>
    </div>
  </header>
  <main class="page">
    <div id="panel">
    <h1>Inventory Control Panel</h1>
    <p class="lead">Offline-ready tools for managing equipment listings. Access is restricted with Hostinger directory protection; no in-browser passwords are used.</p>
    <div class="flex" style="gap:10px; margin:6px 0 14px; flex-wrap:wrap;">
      <a class="btn ghost" href="../Units for Sale.html">View listings page</a>
      <a class="btn ghost" href="admin-log.html">View change log</a>
    </div>
    <div class="notice">Changes are saved in this browser only. Export updated data as JSON or JavaScript for manual upload when you are back online.</div>

    <div class="panel" style="margin-bottom:14px;">
      <div class="row" style="margin-bottom:6px;">
        <div>
          <label for="editorName">Editor name (saved locally)</label>
          <input id="editorName" value="Admin" />
          <p class="muted" style="margin-top:6px;">Used for activity notes in the change log. This is not a login.</p>
        </div>
        <div>
          <label>Data tools</label>
          <div class="flex" style="margin-bottom:0; align-items:center;">
            <button class="btn ghost" id="exportData" type="button">Export JSON</button>
            <button class="btn primary" id="exportScript" type="button">Export as JS</button>
          </div>
          <p class="muted" style="margin-top:6px;">Downloads the current inventory so you can upload it manually later.</p>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2 style="font-size:16px;margin-bottom:10px;">Add or edit listing</h2>
      <div class="row">
        <div>
          <label for="title">Title</label>
          <input id="title" placeholder="2020 Freightliner Cascadia PT126SLP" />
        </div>
        <div>
          <label for="vin">VIN</label>
          <input id="vin" placeholder="1FUJHHDR1LLXXXXXX" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="type">Type</label>
          <select id="type">
            <option>Truck</option>
            <option>Trailer</option>
          </select>
        </div>
        <div>
          <label for="brand">Brand</label>
          <input id="brand" placeholder="Freightliner" />
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option>Available</option>
            <option>Sold</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="price">Price (USD)</label>
          <input id="price" type="number" min="0" step="1" placeholder="38386" />
        </div>
        <div>
          <label for="mileage">Mileage</label>
          <input id="mileage" type="number" min="0" step="1" placeholder="729771" />
        </div>
        <div>
          <label for="state">State</label>
          <input id="state" placeholder="CA" />
        </div>
        <div>
          <label for="color">Color</label>
          <input id="color" placeholder="White" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="year">Model year</label>
          <input id="year" type="number" min="1980" max="2099" placeholder="2020" />
        </div>
        <div>
          <label for="engine">Engine / HP</label>
          <input id="engine" placeholder="DD15 / 455 HP" />
        </div>
        <div>
          <label for="transmission">Transmission</label>
          <input id="transmission" placeholder="12-speed automatic" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="condition">Condition</label>
          <select id="condition">
            <option value="Used">Used</option>
            <option value="New">New</option>
          </select>
        </div>
        <div>
          <label for="location">Location</label>
          <input id="location" placeholder="Los Angeles, CA" />
        </div>
        <div>
          <label for="phone">Contact phone</label>
          <input id="phone" placeholder="000-000-0000" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="description">Description</label>
          <textarea id="description" placeholder="Dealer-maintained, clean title, ready for work." style="min-height:120px;"></textarea>
        </div>
        <div>
          <label for="features">Key features (one per line)</label>
          <textarea id="features" placeholder="Sleeper cab\nAPU\nAluminum wheels" style="min-height:120px;"></textarea>
        </div>
      </div>
      <div class="panel" style="margin-top:10px; background:#f8fbfa; border:1px dashed #cfe2de;">
        <h3 style="font-size:14px; margin-bottom:8px;">Listing photos</h3>
        <p class="muted" style="margin-top:-2px;">Upload or link up to 10 photos. The first image becomes the thumbnail.</p>
        <div class="flex" style="align-items:center; gap:8px; margin:6px 0;">
          <input id="imageUrl" placeholder="https://example.com/unit.jpg" />
          <button class="btn primary" type="button" id="addImageUrl" style="white-space:nowrap;">Add image URL</button>
        </div>
        <div class="flex" style="align-items:center; gap:8px; margin:6px 0 10px;">
          <input id="imageFile" type="file" accept="image/*" />
          <span class="pill">10 images max</span>
        </div>
        <div id="imageList" class="thumb-grid"></div>
      </div>
      <div class="flex" style="justify-content:flex-end;">
        <button class="btn ghost" id="resetForm">Reset</button>
        <button class="btn primary" id="saveUnit">Save Listing</button>
      </div>
    </div>

    <div class="panel" style="margin-top:14px;">
      <div class="flex" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h2 style="font-size:16px;">Current listings</h2>
        <button class="btn ghost" id="exportDataSecondary" type="button">Export JSON</button>
      </div>
      <p class="muted" style="margin-top:-6px;">Cards render on the canvas below. Click a card to select it and use the actions panel.</p>
      <div class="canvas-wrap" id="listingCanvasWrap">
        <canvas id="listingCanvas"></canvas>
      </div>
    </div>

    <div class="panel" id="selectionPanel" style="margin-top:14px;">
      <div class="flex" style="justify-content:space-between; align-items:center;">
        <div>
          <h2 style="font-size:16px;">Selected listing</h2>
          <p class="muted" id="selectedLabel">Nothing selected. Click a card above.</p>
        </div>
        <div class="flex" style="gap:8px; margin-bottom:0;">
          <button class="btn ghost" id="editSelected" type="button" disabled>Edit</button>
          <button class="btn primary" id="deleteSelected" type="button" disabled>Delete</button>
          <button class="btn ghost" id="downloadSelected" type="button" disabled>Download page</button>
        </div>
      </div>
    </div>
  </div>
  </main>

  <script>
    const storageKey = 'inventoryData';
    const auditKey = 'inventoryAuditLog';
    const MIN_LISTINGS = 35;
    const MAX_IMAGES = 10;
    const DEFAULT_IMAGE = 'https://imagescdn.dealercarsearch.com/Media/22484/23001914/638930206131273528.jpg';
    const BASE_UNITS = Array.isArray(window.INVENTORY_SEED) ? window.INVENTORY_SEED : [];

    let units = [];
    let editingIndex = null;
    let imagesState = [];
    let auditLog = [];
    let sortState = { field: 'title', direction: 'asc' };
    let selectedIndex = null;
    const canvas = document.getElementById('listingCanvas');
    const canvasWrap = document.getElementById('listingCanvasWrap');
    const ctx = canvas.getContext('2d');
    let cardBounds = [];

    function normalizeStatus(value) {
      const val = (value || '').toString().trim().toLowerCase();
      if (val === 'sold') return 'Sold';
      return 'Available';
    }

    function getEditorName() {
      const input = document.getElementById('editorName');
      const name = (input?.value || '').trim();
      return name || 'offline-admin';
    }

    function hasDiverseInventory(list) {
      if (!Array.isArray(list) || !list.length) return false;
      const uniqueTitles = new Set(list.map(u => (u.title || '').toLowerCase()));
      return uniqueTitles.size >= Math.min(MIN_LISTINGS, list.length);
    }

    function normalizeUnit(unit) {
      if (!unit) return null;
      const title = unit.title || 'Untitled unit';
      const images = Array.isArray(unit.images) ? unit.images.filter(Boolean) : [];
      const titleYear = (title.match(/(19|20)\d{2}/) || [])[0];
      const year = Number(unit.year) || Number(titleYear) || '';
      const desc = unit.description || `${title} — well maintained, clean title, and ready for your next haul.`;
      const defaultFeatures = ['Clean title', 'DOT ready', 'Fresh PM service', 'Warranty options available', 'Maintenance records on file', 'Financing available'];
      const features = Array.isArray(unit.features) && unit.features.length ? unit.features : defaultFeatures;

      const status = normalizeStatus(unit.status);

      return {
        title,
        vin: unit.vin || '',
        type: unit.type || 'Truck',
        brand: unit.brand || 'Unknown',
        status,
        price: Number(unit.price) || 0,
        mileage: Number(unit.mileage) || 0,
        state: unit.state || 'Unknown',
        color: unit.color || 'Unknown',
        year,
        engine: unit.engine || 'Not specified',
        transmission: unit.transmission || 'Not specified',
        condition: unit.condition || 'Used',
        location: unit.location || (unit.state ? `${unit.state} yard` : 'Available nationwide'),
        phone: unit.phone || '000-000-0000',
        description: desc,
        features,
        images: images.length ? images : [DEFAULT_IMAGE],
        image: images[0] || DEFAULT_IMAGE
      };
    }

    function loadUnits() {
      let parsed = [];
      try {
        const saved = localStorage.getItem(storageKey);
        if (saved) {
          const raw = JSON.parse(saved);
          if (Array.isArray(raw)) parsed = raw;
        }
      } catch (e) {
        console.warn('Could not parse saved inventory');
      }
      const normalized = parsed.map(normalizeUnit).filter(Boolean);
      if (hasDiverseInventory(normalized)) {
        localStorage.setItem(storageKey, JSON.stringify(normalized));
        return normalized;
      }
      const seeded = BASE_UNITS.map(normalizeUnit).filter(Boolean);
      localStorage.setItem(storageKey, JSON.stringify(seeded));
      return seeded;
    }

    function saveUnits() {
      localStorage.setItem(storageKey, JSON.stringify(units));
    }

    function formatNumber(n) {
      return Number(n || 0).toLocaleString('en-US');
    }

    function getSortableValue(unit, field) {
      const numeric = ['price','mileage','year'];
      const value = unit?.[field];
      if (numeric.includes(field)) return Number(value) || 0;
      return (value ?? '').toString().toLowerCase();
    }

    function resizeCanvas(rowCount) {
      const width = canvasWrap.clientWidth - 2;
      const cardHeight = 140;
      canvas.width = width > 0 ? width : 900;
      canvas.height = Math.max(360, rowCount * cardHeight + 40);
    }

    function drawCard(unit, idx, yPosition, isSelected) {
      const padding = 14;
      const cardHeight = 120;
      const status = normalizeStatus(unit.status);
      const statusColor = status === 'Sold' ? '#b30000' : '#005e4a';
      const statusBg = status === 'Sold' ? '#ffe5e5' : '#dff6f0';

      ctx.fillStyle = '#ffffff';
      ctx.strokeStyle = isSelected ? '#005e4a' : '#d8e5e0';
      ctx.lineWidth = isSelected ? 3 : 1;
      ctx.beginPath();
      ctx.roundRect(padding, yPosition, canvas.width - padding * 2, cardHeight, 12);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = '#0b2520';
      ctx.font = '700 16px Inter';
      ctx.fillText(unit.title || 'Untitled', padding + 16, yPosition + 28);

      ctx.fillStyle = '#3f4f49';
      ctx.font = '13px Inter';
      ctx.fillText(`VIN: ${unit.vin || '—'}`, padding + 16, yPosition + 52);
      ctx.fillText(`Year: ${unit.year || '—'}   Type: ${unit.type || '—'}   Brand: ${unit.brand || '—'}   Color: ${unit.color || '—'}`, padding + 16, yPosition + 74);
      ctx.fillText(`Location: ${unit.location || '—'}   State: ${unit.state || '—'}`, padding + 16, yPosition + 96);
      ctx.fillText(`Price: $${formatNumber(unit.price)}   Mileage: ${formatNumber(unit.mileage)} mi`, padding + 16, yPosition + 118);

      ctx.fillStyle = statusBg;
      ctx.strokeStyle = statusColor;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(canvas.width - padding - 120, yPosition + 20, 104, 30, 999);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = statusColor;
      ctx.font = '700 12px Inter';
      ctx.fillText(status, canvas.width - padding - 92, yPosition + 41);

      const actionY = yPosition + 86;
      ctx.fillStyle = '#005e4a';
      ctx.font = '700 12px Inter';
      ctx.fillText('Select to Edit / Delete / Download', canvas.width - padding - 250, actionY);
    }

    function renderTable() {
      const bodyRows = units.map((unit, idx) => ({ unit, idx }));
      bodyRows.sort((a, b) => {
        const field = sortState.field;
        const dir = sortState.direction === 'asc' ? 1 : -1;
        const aVal = getSortableValue(a.unit, field);
        const bVal = getSortableValue(b.unit, field);
        if (aVal < bVal) return -1 * dir;
        if (aVal > bVal) return 1 * dir;
        return 0;
      });

      resizeCanvas(bodyRows.length || 1);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      cardBounds = [];

      if (!bodyRows.length) {
        ctx.fillStyle = '#3f4f49';
        ctx.font = '14px Inter';
        ctx.fillText('No listings yet. Add one above.', 30, 60);
        updateSelectionUI();
        return;
      }

      const gap = 18;
      const cardHeight = 140;
      let currentY = 20;
      bodyRows.forEach((row) => {
        const isSelected = row.idx === selectedIndex;
        drawCard(row.unit, row.idx, currentY, isSelected);
        cardBounds.push({ x: 14, y: currentY, width: canvas.width - 28, height: cardHeight, index: row.idx });
        currentY += cardHeight + gap;
      });

      updateSelectionUI();
    }

    function updateSelectionUI() {
      const label = document.getElementById('selectedLabel');
      const editBtn = document.getElementById('editSelected');
      const deleteBtn = document.getElementById('deleteSelected');
      const downloadBtn = document.getElementById('downloadSelected');
      if (selectedIndex === null || selectedIndex === undefined || selectedIndex < 0 || !units[selectedIndex]) {
        label.textContent = 'Nothing selected. Click a card above.';
        editBtn.disabled = true;
        deleteBtn.disabled = true;
        downloadBtn.disabled = true;
        return;
      }
      const unit = units[selectedIndex];
      label.textContent = `${unit.title || 'Listing'} — ${normalizeStatus(unit.status)}`;
      editBtn.disabled = false;
      deleteBtn.disabled = false;
      downloadBtn.disabled = false;
    }

    function handleCanvasClick(evt) {
      const rect = canvas.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      const hit = cardBounds.find(b => x >= b.x && x <= b.x + b.width && y >= b.y && y <= b.y + b.height);
      if (hit) {
        selectedIndex = hit.index;
        renderTable();
      }
    }

    function renderImages() {
      const list = document.getElementById('imageList');
      if (!list) return;
      list.innerHTML = '';
      if (!imagesState.length) {
        list.innerHTML = '<div class="muted">No images yet. Add up to 10.</div>';
        return;
      }
      imagesState.forEach((src, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.innerHTML = `<img src="${src}" alt="Listing image ${idx+1}" /><button type="button" onclick="removeImage(${idx})">Remove</button>`;
        list.appendChild(wrap);
      });
    }

    function addImage(url) {
      if (!url || !url.trim()) return;
      if (imagesState.length >= MAX_IMAGES) {
        alert('Limit of 10 images reached. Remove one to add another.');
        return;
      }
      imagesState.push(url.trim());
      renderImages();
      const urlInput = document.getElementById('imageUrl');
      if (urlInput) urlInput.value = '';
    }

    function removeImage(index) {
      imagesState.splice(index, 1);
      renderImages();
    }

    function handleFileInput(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        addImage(e.target.result);
      };
      reader.readAsDataURL(file);
      evt.target.value = '';
    }

    function addAuditEntry(action, beforeUnit, afterUnit) {
      const entry = {
        timestamp: new Date().toISOString(),
        action,
        user: getEditorName(),
        vin: afterUnit?.vin || beforeUnit?.vin || '',
        title: afterUnit?.title || beforeUnit?.title || '',
        details: []
      };
      if (action === 'updated' && beforeUnit && afterUnit) {
        entry.details = summarizeChanges(beforeUnit, afterUnit);
      } else if (action === 'created' && afterUnit) {
        entry.details = [`Created listing ${afterUnit.title || afterUnit.vin}`];
      } else if (action === 'deleted' && beforeUnit) {
        entry.details = [`Deleted listing ${beforeUnit.title || beforeUnit.vin}`];
      }
      const current = loadAuditLog();
      current.unshift(entry);
      saveAuditLog(current.slice(0, 500));
    }

    function summarizeChanges(previous, next) {
      const changes = [];
      const fields = ['title','vin','type','brand','status','price','mileage','state','color','year','engine','transmission','condition','location','phone','description'];
      fields.forEach(field => {
        if ((previous?.[field] ?? '') !== (next?.[field] ?? '')) {
          changes.push(`${field} updated`);
        }
      });
      if (JSON.stringify(previous.features || []) !== JSON.stringify(next.features || [])) {
        changes.push('features updated');
      }
      if (JSON.stringify(previous.images || []) !== JSON.stringify(next.images || [])) {
        changes.push('images updated');
      }
      return changes.length ? changes : ['Updated listing'];
    }

    function loadAuditLog() {
      try {
        const saved = JSON.parse(localStorage.getItem(auditKey) || '[]');
        if (Array.isArray(saved)) {
          auditLog = saved;
          return saved;
        }
      } catch (e) {}
      auditLog = [];
      return [];
    }

    function saveAuditLog(entries) {
      auditLog = entries;
      localStorage.setItem(auditKey, JSON.stringify(entries));
    }

    function renderImagesFromUnit(unit) {
      imagesState = (unit.images || []).slice(0, MAX_IMAGES);
      renderImages();
    }

    function saveUnit() {
      const unit = normalizeUnit({
        title: document.getElementById('title').value,
        vin: document.getElementById('vin').value,
        type: document.getElementById('type').value,
        brand: document.getElementById('brand').value,
        status: document.getElementById('status').value,
        price: document.getElementById('price').value,
        mileage: document.getElementById('mileage').value,
        state: document.getElementById('state').value,
        color: document.getElementById('color').value,
        year: document.getElementById('year').value,
        engine: document.getElementById('engine').value,
        transmission: document.getElementById('transmission').value,
        condition: document.getElementById('condition').value,
        location: document.getElementById('location').value,
        phone: document.getElementById('phone').value,
        description: document.getElementById('description').value,
        features: (document.getElementById('features').value || '').split('\n').filter(Boolean),
        images: imagesState
      });

      if (editingIndex !== null && editingIndex !== undefined) {
        const before = units[editingIndex];
        units[editingIndex] = unit;
        addAuditEntry('updated', before, unit);
        selectedIndex = editingIndex;
      } else {
        units.push(unit);
        addAuditEntry('created', null, unit);
        selectedIndex = units.length - 1;
      }

      saveUnits();
      renderTable();
      resetForm();
    }

    function resetForm() {
      editingIndex = null;
      imagesState = [];
      selectedIndex = null;
      ['title','vin','brand','color','state','year','engine','transmission','location','phone','description','features'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('type').value = 'Truck';
      document.getElementById('status').value = 'Available';
      document.getElementById('condition').value = 'Used';
      document.getElementById('price').value = '';
      document.getElementById('mileage').value = '';
      const phoneInput = document.getElementById('phone');
      if (phoneInput) phoneInput.value = '000-000-0000';
      renderImages();
      updateSelectionUI();
    }

    function editUnit(index) {
      const unit = units[index];
      if (!unit) return;
      editingIndex = index;
      selectedIndex = index;
      document.getElementById('title').value = unit.title || '';
      document.getElementById('vin').value = unit.vin || '';
      document.getElementById('type').value = unit.type || 'Truck';
      document.getElementById('brand').value = unit.brand || '';
      document.getElementById('status').value = unit.status || 'Available';
      document.getElementById('price').value = unit.price || '';
      document.getElementById('mileage').value = unit.mileage || '';
      document.getElementById('state').value = unit.state || '';
      document.getElementById('color').value = unit.color || '';
      document.getElementById('year').value = unit.year || '';
      document.getElementById('engine').value = unit.engine || '';
      document.getElementById('transmission').value = unit.transmission || '';
      document.getElementById('condition').value = unit.condition || 'Used';
      document.getElementById('location').value = unit.location || '';
      document.getElementById('phone').value = unit.phone || '000-000-0000';
      document.getElementById('description').value = unit.description || '';
      document.getElementById('features').value = (unit.features || []).join('\n');
      renderImagesFromUnit(unit);
      renderTable();
    }

    function deleteUnit(index) {
      const removed = units.splice(index, 1)[0];
      if (removed) addAuditEntry('deleted', removed, null);
      selectedIndex = null;
      saveUnits();
      renderTable();
      resetForm();
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(units, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory-data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportScript() {
      const payload = `const INVENTORY_SEED = ${JSON.stringify(units, null, 2)};`;
      const blob = new Blob([payload], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory-data.js';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportAuditLog() {
      const blob = new Blob([JSON.stringify(auditLog, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory-audit-log.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadDetailPage(index) {
      const unit = units[index];
      if (!unit) return;
      const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>${unit.title}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .hero { max-width: 100%; border-radius: 12px; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef6f3; border:1px solid #cfe2de; }
  </style>
</head>
<body>
  <h1>${unit.title}</h1>
  <p class="pill">${unit.status || 'Available'}</p>
  <p><strong>VIN:</strong> ${unit.vin}</p>
  <p><strong>Price:</strong> $${formatNumber(unit.price)}</p>
  <p><strong>Location:</strong> ${unit.location || ''}</p>
  <p><strong>Mileage:</strong> ${formatNumber(unit.mileage)}</p>
  <p><strong>Engine:</strong> ${unit.engine || ''}</p>
  <p><strong>Transmission:</strong> ${unit.transmission || ''}</p>
  <p><strong>Condition:</strong> ${unit.condition || ''}</p>
  <p><strong>Contact:</strong> ${unit.phone || ''}</p>
  <p>${unit.description || ''}</p>
  <img class="hero" src="${unit.image}" alt="${unit.title}" />
  <h3>Features</h3>
  <ul>${(unit.features || []).map(f => `<li>${f}</li>`).join('')}</ul>
</body>
</html>`;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(unit.title || 'unit').replace(/[^a-z0-9]+/gi,'-').toLowerCase()}-detail.html`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function bindEvents() {
      document.getElementById('saveUnit').addEventListener('click', saveUnit);
      document.getElementById('resetForm').addEventListener('click', resetForm);
      document.getElementById('exportData').addEventListener('click', exportData);
      document.getElementById('exportDataSecondary').addEventListener('click', exportData);
      document.getElementById('exportScript').addEventListener('click', exportScript);
      document.getElementById('addImageUrl').addEventListener('click', () => addImage(document.getElementById('imageUrl').value));
      document.getElementById('imageFile').addEventListener('change', handleFileInput);
      canvas.addEventListener('click', handleCanvasClick);
      window.addEventListener('resize', () => renderTable());
      document.getElementById('editSelected').addEventListener('click', () => editUnit(selectedIndex));
      document.getElementById('deleteSelected').addEventListener('click', () => deleteUnit(selectedIndex));
      document.getElementById('downloadSelected').addEventListener('click', () => downloadDetailPage(selectedIndex));
    }

    units = loadUnits();
    loadAuditLog();
    renderTable();
    renderImages();
    bindEvents();
  </script>
</body>
</html>
