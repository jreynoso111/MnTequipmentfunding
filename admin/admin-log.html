<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Change Log</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root { --font-main: "Inter","Segoe UI",system-ui,-apple-system,sans-serif; }
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; font-family:var(--font-main); }
    body { background:#f5f7f6; color:#0b2520; padding:0; line-height:1.5; }
    a { color: inherit; text-decoration: none; }
    header.site-header { background:#ffffff; position:sticky; top:0; z-index:50; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .nav { max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:10px 20px;gap:12px; }
    .logo { display:flex; align-items:center; gap:10px; }
    .logo img { height:60px; width:auto; object-fit:contain; }
    .nav-links { display:flex; align-items:center; gap:18px; font-size:14px; flex-wrap:wrap; }
    .nav-links a { padding:6px 10px; border-radius:999px; }
    .nav-links a:hover { background:rgba(0,94,74,.08); }
    .nav-links .active { background:#005e4a; color:#fff; }
    .btn-small { border-radius:999px; border:1px solid #005e4a; padding:10px 22px; font-size:14px; font-weight:700; color:#005e4a; background:#fff; cursor:pointer; }
    .btn-small:hover { background:#005e4a; color:#fff; }
    .page { max-width:1200px; margin:20px auto 40px; padding:0 20px; }
    h1 { font-size:26px; font-weight:800; margin-bottom:6px; }
    p.lead { font-size:13px; color:#3d4a47; margin-bottom:16px; }
    .panel { background:#fff; border:1px solid #d8e5e0; border-radius:12px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.06); }
    .btn { border:none; border-radius:999px; padding:10px 16px; font-weight:700; font-size:13px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
    .btn.primary { background:#005e4a; color:#fff; }
    .btn.ghost { background:#fff; color:#005e4a; border:1px solid #005e4a; }
    .muted { color:#4d5b57; font-size:12px; }
    .badge { display:inline-flex; align-items:center; padding:4px 8px; background:#eef6f3; border:1px solid #cfe2de; border-radius:999px; font-size:11px; font-weight:700; color:#0b2520; }
    .flex { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .canvas-wrap { width:100%; background:#f8fbfa; border:1px dashed #cfe2de; border-radius:12px; overflow:auto; }
    canvas { display:block; width:100%; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="nav">
      <div class="logo">
        <a href="../index.html"><img src="../Media/LogoTransparent.png" alt="M&T Equipment Funding Logo"></a>
      </div>
      <nav class="nav-links">
        <a href="control-panel.html">Control Panel</a>
        <a href="reports.html">Reports</a>
        <a href="admin-log.html" class="active">Admin Log</a>
        <a href="../index.html">Back to Site</a>
        <button class="btn-small" type="button" data-track-id="cta_talk_rep" data-track-label="Talk to Representative" onclick="window.location.href='tel:2012013551'">Talk to Representative</button>
      </nav>
    </div>
  </header>

  <main class="page">
    <h1>Inventory change log</h1>
    <p class="lead">Offline record of edits made in the browser. Directory protection keeps this page private; no in-page passwords are used.</p>
    <div class="flex" style="margin:10px 0 14px;">
      <a class="btn ghost" href="control-panel.html">Back to control panel</a>
      <a class="btn primary" href="../Units for Sale.html">View listings</a>
      <button class="btn ghost" id="clearLog" type="button">Clear log</button>
      <button class="btn primary" id="exportLog" type="button">Export log</button>
    </div>

    <div class="panel">
      <div class="flex" style="justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="font-size:16px;">Activity timeline</h2>
        <span class="badge" id="entryCount">0 entries</span>
      </div>
      <p class="muted" style="margin-top:-6px;">Entries render across the full-width canvas below for quick scanning.</p>
      <div class="canvas-wrap" id="logCanvasWrap">
        <canvas id="logCanvas"></canvas>
      </div>
    </div>
  </main>

  <script>
    const auditKey = 'inventoryAuditLog';
    const canvas = document.getElementById('logCanvas');
    const canvasWrap = document.getElementById('logCanvasWrap');
    const ctx = canvas.getContext('2d');

    function loadAuditLog() {
      try {
        const saved = JSON.parse(localStorage.getItem(auditKey) || '[]');
        if (Array.isArray(saved)) return saved;
      } catch (e) {}
      return [];
    }

    function saveAuditLog(entries) {
      localStorage.setItem(auditKey, JSON.stringify(entries));
    }

    function formatTime(ts) {
      try {
        return new Date(ts).toLocaleString();
      } catch (e) {
        return ts;
      }
    }

    function resizeCanvas(count) {
      const width = canvasWrap.clientWidth - 2;
      canvas.width = width > 0 ? width : 1000;
      canvas.height = Math.max(440, 120 + count * 80);
    }

    function drawEntry(entry, index, baseY) {
      const y = baseY + index * 80;
      const padding = 18;
      const cardHeight = 64;
      ctx.fillStyle = '#ffffff';
      ctx.strokeStyle = '#d8e5e0';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(padding, y, canvas.width - padding * 2, cardHeight, 12);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = '#0b2520';
      ctx.font = '700 15px Inter';
      ctx.fillText(`${entry.action || 'updated'} — ${entry.title || entry.vin || 'Listing'}`, padding + 14, y + 24);

      ctx.fillStyle = '#3f4f49';
      ctx.font = '13px Inter';
      ctx.fillText(`Editor: ${entry.user || 'offline-admin'} | VIN: ${entry.vin || '—'} | ${formatTime(entry.timestamp)}`, padding + 14, y + 44);

      ctx.fillStyle = '#005e4a';
      ctx.font = '12px Inter';
      const detailText = (entry.details || []).join(' • ') || 'No detail provided';
      const clipped = detailText.length > 120 ? detailText.slice(0, 117) + '…' : detailText;
      ctx.fillText(clipped, padding + 14, y + 62);
    }

    function drawEmptyState() {
      ctx.fillStyle = '#3f4f49';
      ctx.font = '14px Inter';
      ctx.fillText('No activity recorded yet.', 26, 70);
    }

    function renderLog() {
      const entries = loadAuditLog();
      document.getElementById('entryCount').textContent = `${entries.length} entr${entries.length === 1 ? 'y' : 'ies'}`;
      resizeCanvas(entries.length);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#0b2520';
      ctx.font = '700 18px Inter';
      ctx.fillText('Change log canvas', 20, 34);

      if (!entries.length) {
        drawEmptyState();
        return;
      }

      const baseY = 56;
      entries.forEach((entry, idx) => drawEntry(entry, idx, baseY));
    }

    function clearLog() {
      if (!confirm('Clear the change log stored in this browser?')) return;
      saveAuditLog([]);
      renderLog();
    }

    function exportLog() {
      const entries = loadAuditLog();
      const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory-audit-log.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('clearLog').addEventListener('click', clearLog);
    document.getElementById('exportLog').addEventListener('click', exportLog);
    document.addEventListener('DOMContentLoaded', renderLog);
    window.addEventListener('resize', renderLog);
  </script>
</body>
</html>
